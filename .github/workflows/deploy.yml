name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Run tests (if any)
      run: npm test || true

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: 5.129.250.45
        username: root
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          cd /var/www/tatyankin-portfolio.online

          # Backup current version
          echo "Creating backup..."
          cp -r . ../backup-$(date +%Y%m%d_%H%M%S) 2>/dev/null || true

          # Pull latest changes
          echo "Pulling latest changes..."
          git pull origin main

          # Install dependencies
          echo "Installing dependencies..."
          npm install --production

          # Restart application
          echo "Restarting application..."
          pm2 restart hrskipbot || pm2 start ecosystem.config.js

          # Show status
          echo "Deployment completed!"
          pm2 status
          
          # Wait a moment for app to start
          sleep 3
          
          # Check if app is running (timeout after 5 seconds)
          timeout 5 pm2 logs hrskipbot --lines 5 --nostream || echo "Logs check completed"