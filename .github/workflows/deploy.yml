name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm install --prefer-offline --no-audit

    - name: Run tests (if any)
      run: npm test || true

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: 5.129.250.45
        username: root
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        timeout: 300s
        command_timeout: 300s
        script: |
          set -e
          cd /var/www/tatyankin-portfolio.online

          # Backup current version
          echo "Creating backup..."
          cp -r . ../backup-$(date +%Y%m%d_%H%M%S) 2>/dev/null || true

          # Pull latest changes
          echo "Pulling latest changes..."
          git pull origin main || { echo "Git pull failed"; exit 1; }

          # Install dependencies (with timeout)
          echo "Installing dependencies..."
          timeout 180 npm install --production --prefer-offline --no-audit || { echo "npm install failed or timed out"; exit 1; }

          # Restart application
          echo "Restarting application..."
          pm2 restart hrskipbot 2>/dev/null || pm2 start ecosystem.config.js || { echo "PM2 restart failed"; exit 1; }

          # Show status (quick check)
          echo "Deployment completed!"
          pm2 status --no-color
          
          # Quick health check
          sleep 2
          if pm2 jlist | grep -q '"name":"hrskipbot"'; then
            echo "✅ Application is running"
          else
            echo "⚠️ Application status unclear"
          fi